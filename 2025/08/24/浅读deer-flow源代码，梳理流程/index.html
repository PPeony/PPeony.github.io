
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>浅读deer-flow源代码，梳理流程 - peony&#39;s blogs</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="peony,"> 
    <meta name="description" content="浅读deer-flow源代码，梳理流程只是浅显的debug，读了一下，文内可能有不对的地方，请多包涵。
调试时候注意几点：

token消耗量巨大，一下午消耗1m的token。迭代次数调低，完整跑一,"> 
    <meta name="author" content="peony"> 
    <link rel="alternative" href="atom.xml" title="peony&#39;s blogs" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon63.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">peony&#39;s blogs</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" data-url="https://ppeony.github.io"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">浅读deer-flow源代码，梳理流程</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <!--<a title="获取二维码" class="icon-scan" href="javascript:;" ></a>-->
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">浅读deer-flow源代码，梳理流程</h1>
        <div class="stuff">
            <span>八月 24, 2025</span>
            

        </div>
        <div class="content markdown">
            <h1 id="浅读deer-flow源代码，梳理流程"><a href="#浅读deer-flow源代码，梳理流程" class="headerlink" title="浅读deer-flow源代码，梳理流程"></a>浅读deer-flow源代码，梳理流程</h1><p>只是浅显的debug，读了一下，文内可能有不对的地方，请多包涵。</p>
<p>调试时候注意几点：</p>
<ol>
<li>token消耗量巨大，一下午消耗1m的token。迭代次数调低，完整跑一次估计要400k~500k。</li>
<li>已经试过qwen-max不行，deepseek-chat不行。只有doubao可以。</li>
</ol>
<h1 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h1><p>构建的图位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_build_base_graph</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Build and return the base state graph with all nodes and edges."""</span></span><br><span class="line">    builder = StateGraph(State)</span><br><span class="line">    builder.add_edge(START, <span class="string">"coordinator"</span>)</span><br><span class="line">    builder.add_node(<span class="string">"coordinator"</span>, coordinator_node)</span><br><span class="line">    builder.add_node(<span class="string">"background_investigator"</span>, background_investigation_node)</span><br><span class="line">    builder.add_node(<span class="string">"planner"</span>, planner_node)</span><br><span class="line">    builder.add_node(<span class="string">"reporter"</span>, reporter_node)</span><br><span class="line">    builder.add_node(<span class="string">"research_team"</span>, research_team_node)</span><br><span class="line">    builder.add_node(<span class="string">"researcher"</span>, researcher_node)</span><br><span class="line">    builder.add_node(<span class="string">"coder"</span>, coder_node)</span><br><span class="line">    builder.add_node(<span class="string">"human_feedback"</span>, human_feedback_node)</span><br><span class="line">    builder.add_edge(<span class="string">"background_investigator"</span>, <span class="string">"planner"</span>)</span><br><span class="line">    builder.add_conditional_edges(</span><br><span class="line">        <span class="string">"research_team"</span>,</span><br><span class="line">        continue_to_running_research_team,</span><br><span class="line">        [<span class="string">"planner"</span>, <span class="string">"researcher"</span>, <span class="string">"coder"</span>],</span><br><span class="line">    )</span><br><span class="line">    builder.add_edge(<span class="string">"reporter"</span>, END)</span><br><span class="line">    <span class="keyword">return</span> builder</span><br></pre></td></tr></table></figure>

<p>下面逐个分析</p>
<h1 id="coordinator-node"><a href="#coordinator-node" class="headerlink" title="coordinator_node"></a>coordinator_node</h1><p>提交问题之后，就会到这个节点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coordinator_node</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state: State, config: RunnableConfig</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["planner", "background_investigator", "__end__"]]:</span></span><br><span class="line">    <span class="string">"""Coordinator node that communicate with customers."""</span></span><br><span class="line">    logger.info(<span class="string">"Coordinator talking."</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    messages = apply_prompt_template(<span class="string">"coordinator"</span>, state) <span class="comment"># prompt就是coordinator.md。里面指示了 llm需要做什么，对每种情况如何回复，什么时候需要分发请求。</span></span><br><span class="line">    response = (</span><br><span class="line">        get_llm_by_type(AGENT_LLM_MAP[<span class="string">"coordinator"</span>])</span><br><span class="line">        .bind_tools([handoff_to_planner])</span><br><span class="line">        .invoke(messages)</span><br><span class="line">    ) <span class="comment"># 初始化 llm 客户端 并调用llm</span></span><br><span class="line">    <span class="comment"># 这里prompt指定多数情况都调用handoff_to_planner，</span></span><br><span class="line">    logger.debug(<span class="string">f"Current state messages: <span class="subst">&#123;state[<span class="string">'messages'</span>]&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    goto = <span class="string">"__end__"</span></span><br><span class="line">    locale = state.get(<span class="string">"locale"</span>, <span class="string">"en-US"</span>)  <span class="comment"># Default locale if not specified</span></span><br><span class="line">    research_topic = state.get(<span class="string">"research_topic"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(response.tool_calls) &gt; <span class="number">0</span>: <span class="comment"># 检查大模型想不想要调用工具</span></span><br><span class="line">        goto = <span class="string">"planner"</span></span><br><span class="line">        <span class="keyword">if</span> state.get(<span class="string">"enable_background_investigation"</span>):</span><br><span class="line">            <span class="comment"># if the search_before_planning is True, add the web search tool to the planner agent</span></span><br><span class="line">            goto = <span class="string">"background_investigator"</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> tool_call <span class="keyword">in</span> response.tool_calls:</span><br><span class="line">                <span class="keyword">if</span> tool_call.get(<span class="string">"name"</span>, <span class="string">""</span>) != <span class="string">"handoff_to_planner"</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> tool_call.get(<span class="string">"args"</span>, &#123;&#125;).get(<span class="string">"locale"</span>) <span class="keyword">and</span> tool_call.get(</span><br><span class="line">                    <span class="string">"args"</span>, &#123;&#125;</span><br><span class="line">                ).get(<span class="string">"research_topic"</span>): </span><br><span class="line">                <span class="comment"># 如果大模型调用工具，它会返回要调用的工具名，也就是 handoff_to_planner，还有这个函数的参数 research_topic 就是我们输入的提问</span></span><br><span class="line">                    locale = tool_call.get(<span class="string">"args"</span>, &#123;&#125;).get(<span class="string">"locale"</span>)</span><br><span class="line">                    research_topic = tool_call.get(<span class="string">"args"</span>, &#123;&#125;).get(<span class="string">"research_topic"</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f"Error processing tool calls: <span class="subst">&#123;e&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(</span><br><span class="line">            <span class="string">"Coordinator response contains no tool calls. Terminating workflow execution."</span></span><br><span class="line">        )</span><br><span class="line">        logger.debug(<span class="string">f"Coordinator response: <span class="subst">&#123;response&#125;</span>"</span>)</span><br><span class="line">    messages = state.get(<span class="string">"messages"</span>, [])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用函数的情况下没有 content，返回一个command，第一次进来 goto=background_investigator</span></span><br><span class="line">    <span class="keyword">if</span> response.content:</span><br><span class="line">        messages.append(HumanMessage(content=response.content, name=<span class="string">"coordinator"</span>))</span><br><span class="line">    <span class="keyword">return</span> Command(</span><br><span class="line">        update=&#123;</span><br><span class="line">            <span class="string">"messages"</span>: messages,</span><br><span class="line">            <span class="string">"locale"</span>: locale,</span><br><span class="line">            <span class="string">"research_topic"</span>: research_topic,</span><br><span class="line">            <span class="string">"resources"</span>: configurable.resources,</span><br><span class="line">        &#125;,</span><br><span class="line">        goto=goto,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h1 id="background-investigation"><a href="#background-investigation" class="headerlink" title="background_investigation"></a>background_investigation</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">background_investigation_node</span><span class="params">(state: State, config: RunnableConfig)</span>:</span></span><br><span class="line">    logger.info(<span class="string">"background investigation node is running."</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    query = state.get(<span class="string">"research_topic"</span>)</span><br><span class="line">    background_investigation_results = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> SELECTED_SEARCH_ENGINE == SearchEngine.TAVILY.value:</span><br><span class="line">        searched_content = LoggedTavilySearch(</span><br><span class="line">            max_results=configurable.max_search_results</span><br><span class="line">        ).invoke(query)</span><br><span class="line">        <span class="keyword">if</span> isinstance(searched_content, list):</span><br><span class="line">            <span class="comment"># 把TAVILY的搜索结果拼起来，然后就返回</span></span><br><span class="line">            background_investigation_results = [</span><br><span class="line">                <span class="string">f"## <span class="subst">&#123;elem[<span class="string">'title'</span>]&#125;</span>\n\n<span class="subst">&#123;elem[<span class="string">'content'</span>]&#125;</span>"</span> <span class="keyword">for</span> elem <span class="keyword">in</span> searched_content</span><br><span class="line">            ]</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">"background_investigation_results"</span>: <span class="string">"\n\n"</span>.join(</span><br><span class="line">                    background_investigation_results</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f"Tavily search returned malformed response: <span class="subst">&#123;searched_content&#125;</span>"</span></span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        background_investigation_results = get_web_search_tool(</span><br><span class="line">            configurable.max_search_results</span><br><span class="line">        ).invoke(query)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">"background_investigation_results"</span>: json.dumps(</span><br><span class="line">            background_investigation_results, ensure_ascii=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在构建图的时候，有一段代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.add_edge(<span class="string">"background_investigator"</span>, <span class="string">"planner"</span>)</span><br></pre></td></tr></table></figure>

<p>所以下一个是planner节点</p>
<h1 id="planner-node"><a href="#planner-node" class="headerlink" title="planner_node"></a>planner_node</h1><p>这个planner的markdown写的是真全，太长了就不贴上来了。<a href="https://github.com/bytedance/deer-flow/blob/main/src/prompts/planner.md" target="_blank" rel="noopener">链接地址</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">planner_node</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state: State, config: RunnableConfig</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["human_feedback", "reporter"]]:</span></span><br><span class="line">    <span class="string">"""Planner node that generate the full plan."""</span></span><br><span class="line">    logger.info(<span class="string">"Planner generating full plan"</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    plan_iterations = state[<span class="string">"plan_iterations"</span>] <span class="keyword">if</span> state.get(<span class="string">"plan_iterations"</span>, <span class="number">0</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    messages = apply_prompt_template(<span class="string">"planner"</span>, state, configurable)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.get(<span class="string">"enable_background_investigation"</span>) <span class="keyword">and</span> state.get(</span><br><span class="line">        <span class="string">"background_investigation_results"</span></span><br><span class="line">    ):</span><br><span class="line">        <span class="comment"># background_investigation_results 是上一步查询的初始结果</span></span><br><span class="line">        messages += [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"role"</span>: <span class="string">"user"</span>,</span><br><span class="line">                <span class="string">"content"</span>: (</span><br><span class="line">                    <span class="string">"background investigation results of user query:\n"</span></span><br><span class="line">                    + state[<span class="string">"background_investigation_results"</span>]</span><br><span class="line">                    + <span class="string">"\n"</span></span><br><span class="line">                ),</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> configurable.enable_deep_thinking:</span><br><span class="line">        llm = get_llm_by_type(<span class="string">"reasoning"</span>)</span><br><span class="line">    <span class="keyword">elif</span> AGENT_LLM_MAP[<span class="string">"planner"</span>] == <span class="string">"basic"</span>: <span class="comment"># 进入这里</span></span><br><span class="line">        llm = get_llm_by_type(<span class="string">"basic"</span>).with_structured_output(</span><br><span class="line">            Plan,</span><br><span class="line">            <span class="comment"># method="json_mode",</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        llm = get_llm_by_type(AGENT_LLM_MAP[<span class="string">"planner"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the plan iterations is greater than the max plan iterations, return the reporter node</span></span><br><span class="line">    <span class="keyword">if</span> plan_iterations &gt;= configurable.max_plan_iterations:</span><br><span class="line">        <span class="keyword">return</span> Command(goto=<span class="string">"reporter"</span>)</span><br><span class="line"></span><br><span class="line">    full_response = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> AGENT_LLM_MAP[<span class="string">"planner"</span>] == <span class="string">"basic"</span> <span class="keyword">and</span> <span class="keyword">not</span> configurable.enable_deep_thinking:</span><br><span class="line">        response = llm.invoke(messages)</span><br><span class="line">        full_response = response.model_dump_json(indent=<span class="number">4</span>, exclude_none=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = llm.stream(messages)</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> response:</span><br><span class="line">            full_response += chunk.content</span><br><span class="line">    logger.debug(<span class="string">f"Current state messages: <span class="subst">&#123;state[<span class="string">'messages'</span>]&#125;</span>"</span>)</span><br><span class="line">    logger.info(<span class="string">f"Planner response: <span class="subst">&#123;full_response&#125;</span>"</span>)</span><br><span class="line">    <span class="comment"># response的结果取决于plan的prompt，llm会thought然后列出他要做的每一个step</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        curr_plan = json.loads(repair_json_output(full_response))</span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">        logger.warning(<span class="string">"Planner response is not a valid JSON"</span>)</span><br><span class="line">        <span class="keyword">if</span> plan_iterations &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Command(goto=<span class="string">"reporter"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Command(goto=<span class="string">"__end__"</span>)</span><br><span class="line">    <span class="keyword">if</span> isinstance(curr_plan, dict) <span class="keyword">and</span> curr_plan.get(<span class="string">"has_enough_context"</span>): <span class="comment"># llm觉得够了的情况</span></span><br><span class="line">        logger.info(<span class="string">"Planner response has enough context."</span>)</span><br><span class="line">        new_plan = Plan.model_validate(curr_plan)</span><br><span class="line">        <span class="keyword">return</span> Command(</span><br><span class="line">            update=&#123;</span><br><span class="line">                <span class="string">"messages"</span>: [AIMessage(content=full_response, name=<span class="string">"planner"</span>)],</span><br><span class="line">                <span class="string">"current_plan"</span>: new_plan,</span><br><span class="line">            &#125;,</span><br><span class="line">            goto=<span class="string">"reporter"</span>,</span><br><span class="line">        )</span><br><span class="line">    <span class="comment"># 否则需要继续查</span></span><br><span class="line">    <span class="keyword">return</span> Command(</span><br><span class="line">        update=&#123;</span><br><span class="line">            <span class="string">"messages"</span>: [AIMessage(content=full_response, name=<span class="string">"planner"</span>)],</span><br><span class="line">            <span class="string">"current_plan"</span>: full_response,</span><br><span class="line">        &#125;,</span><br><span class="line">        goto=<span class="string">"human_feedback"</span>,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>这是response的输出结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"locale"</span>: <span class="string">"en-US"</span>,</span><br><span class="line">    <span class="attr">"has_enough_context"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"thought"</span>: <span class="string">"The user wants to know who Donald Trump is. The existing information mainly covers his basic personal details, political tenure, and some legal issues, but lacks comprehensive coverage in aspects such as historical business development, current political influence, future political trends, various stakeholder perspectives, more detailed quantitative and qualitative data, and in - depth comparative analysis. So, more information needs to be gathered."</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"Comprehensive Research on Donald Trump"</span>,</span><br><span class="line">    <span class="attr">"steps"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"need_search"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Research on Trump's Business and Historical Political Development"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"Gather detailed historical data on Trump's business development in real estate, sports, and entertainment. Find out about the significant events, challenges, and turning points in the history of The Trump Organization. Also, collect information on the historical background and development of his political journey before the 2016 and 2024 presidential elections, including his political stances, policy - making processes, and the impact of his early political activities."</span>,</span><br><span class="line">            <span class="attr">"step_type"</span>: <span class="string">"research"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"need_search"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Collection of Current Political and Social Impact Data"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"Collect current data on Trump's political influence, including his current policy positions, his influence on the Republican Party, and his impact on current political debates in the United States. Also, gather information on how different social groups view Trump, such as the attitudes of voters, business communities, and international stakeholders. Find the latest news and reports on his public activities and statements."</span>,</span><br><span class="line">            <span class="attr">"step_type"</span>: <span class="string">"research"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"need_search"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Analysis of Future Political Trends and Comparative Data"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"Search for forecasts and projections about Trump's future political influence, potential future political actions, and possible scenarios in future U.S. politics. Additionally, conduct a comparative analysis of Trump with other U.S. presidents, especially those who served non - consecutive terms like Grover Cleveland, in terms of policies, leadership styles, and historical legacies. Collect comprehensive statistics and data related to Trump's political achievements, approval ratings, and economic impacts during his presidencies for a more in - depth comparison."</span>,</span><br><span class="line">            <span class="attr">"step_type"</span>: <span class="string">"research"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面最后的goto到human_feedback<br>先看human_feedback</p>
<h1 id="human-feedback"><a href="#human-feedback" class="headerlink" title="human_feedback"></a>human_feedback</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">human_feedback_node</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["planner", "research_team", "reporter", "__end__"]]:</span></span><br><span class="line">    current_plan = state.get(<span class="string">"current_plan"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="comment"># check if the plan is auto accepted</span></span><br><span class="line">    auto_accepted_plan = state.get(<span class="string">"auto_accepted_plan"</span>, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> auto_accepted_plan: <span class="comment"># auto_accepted_plan 表示是否自动，如果不是自动，就需要人类反馈，我这里是 true，</span></span><br><span class="line">        feedback = interrupt(<span class="string">"Please Review the Plan."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if the feedback is not accepted, return the planner node</span></span><br><span class="line">        <span class="keyword">if</span> feedback <span class="keyword">and</span> str(feedback).upper().startswith(<span class="string">"[EDIT_PLAN]"</span>):</span><br><span class="line">            <span class="keyword">return</span> Command(</span><br><span class="line">                update=&#123;</span><br><span class="line">                    <span class="string">"messages"</span>: [</span><br><span class="line">                        HumanMessage(content=feedback, name=<span class="string">"feedback"</span>),</span><br><span class="line">                    ],</span><br><span class="line">                &#125;,</span><br><span class="line">                goto=<span class="string">"planner"</span>,</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> feedback <span class="keyword">and</span> str(feedback).upper().startswith(<span class="string">"[ACCEPTED]"</span>):</span><br><span class="line">            logger.info(<span class="string">"Plan is accepted by user."</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f"Interrupt value of <span class="subst">&#123;feedback&#125;</span> is not supported."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the plan is accepted, run the following node</span></span><br><span class="line">    plan_iterations = state[<span class="string">"plan_iterations"</span>] <span class="keyword">if</span> state.get(<span class="string">"plan_iterations"</span>, <span class="number">0</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    goto = <span class="string">"research_team"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        current_plan = repair_json_output(current_plan)</span><br><span class="line">        <span class="comment"># increment the plan iterations</span></span><br><span class="line">        plan_iterations += <span class="number">1</span></span><br><span class="line">        <span class="comment"># parse the plan</span></span><br><span class="line">        new_plan = json.loads(current_plan)</span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">        logger.warning(<span class="string">"Planner response is not a valid JSON"</span>)</span><br><span class="line">        <span class="keyword">if</span> plan_iterations &gt; <span class="number">1</span>:  <span class="comment"># the plan_iterations is increased before this check</span></span><br><span class="line">            <span class="keyword">return</span> Command(goto=<span class="string">"reporter"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Command(goto=<span class="string">"__end__"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Command(</span><br><span class="line">        update=&#123;</span><br><span class="line">            <span class="string">"current_plan"</span>: Plan.model_validate(new_plan), <span class="comment"># 把json转成类对象</span></span><br><span class="line">            <span class="string">"plan_iterations"</span>: plan_iterations,</span><br><span class="line">            <span class="string">"locale"</span>: new_plan[<span class="string">"locale"</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        goto=goto,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>代码比较简单，如果不需要人工干预，就是修复一下json然后返回。<br>当前goto是research_team</p>
<h1 id="research-team"><a href="#research-team" class="headerlink" title="research_team"></a>research_team</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">research_team_node</span><span class="params">(state: State)</span>:</span></span><br><span class="line">    <span class="string">"""Research team node that collaborates on tasks."""</span></span><br><span class="line">    logger.info(<span class="string">"Research team is collaborating on tasks."</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>在构建图的时候有一步，决定research_team下一步去哪</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">builder.add_conditional_edges(</span><br><span class="line">        <span class="string">"research_team"</span>,</span><br><span class="line">        continue_to_running_research_team,</span><br><span class="line">        [<span class="string">"planner"</span>, <span class="string">"researcher"</span>, <span class="string">"coder"</span>],</span><br><span class="line">    )</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">continue_to_running_research_team</span><span class="params">(state: State)</span>:</span></span><br><span class="line">    current_plan = state.get(<span class="string">"current_plan"</span>) <span class="comment"># current_plan 就是上一步生成的plan</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_plan <span class="keyword">or</span> <span class="keyword">not</span> current_plan.steps:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> all(step.execution_res <span class="keyword">for</span> step <span class="keyword">in</span> current_plan.steps): <span class="comment"># 所有plan都有结果了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find first incomplete step</span></span><br><span class="line">    incomplete_step = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> current_plan.steps:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> step.execution_res:</span><br><span class="line">            incomplete_step = step</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> incomplete_step:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># step_type也是上一步planner生成的</span></span><br><span class="line">    <span class="keyword">if</span> incomplete_step.step_type == StepType.RESEARCH:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"researcher"</span></span><br><span class="line">    <span class="keyword">if</span> incomplete_step.step_type == StepType.PROCESSING:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"coder"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"planner"</span></span><br></pre></td></tr></table></figure>

<p>下一步会进入researcher</p>
<h1 id="researcher-node"><a href="#researcher-node" class="headerlink" title="researcher_node"></a>researcher_node</h1><p>调用搜索函数，搜索，我这里会调用Tavily</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">researcher_node</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state: State, config: RunnableConfig</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["research_team"]]:</span></span><br><span class="line">    <span class="string">"""Researcher node that do research"""</span></span><br><span class="line">    logger.info(<span class="string">"Researcher node is researching."</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    tools = [get_web_search_tool(configurable.max_search_results), crawl_tool]</span><br><span class="line">    retriever_tool = get_retriever_tool(state.get(<span class="string">"resources"</span>, []))</span><br><span class="line">    <span class="keyword">if</span> retriever_tool:</span><br><span class="line">        tools.insert(<span class="number">0</span>, retriever_tool)</span><br><span class="line">    logger.info(<span class="string">f"Researcher tools: <span class="subst">&#123;tools&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> _setup_and_execute_agent_step(</span><br><span class="line">        state,</span><br><span class="line">        config,</span><br><span class="line">        <span class="string">"researcher"</span>,</span><br><span class="line">        tools,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>_setup_and_execute_agent_step 会判断有没有mcp，如果没有mcp，会调用search函数，然后传入researcher的prompt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> mcp_servers:</span><br><span class="line">   ...</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Use default tools if no MCP servers are configured</span></span><br><span class="line">    agent = create_agent(agent_type, agent_type, default_tools, agent_type)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> _execute_agent_step(state, agent, agent_type)</span><br></pre></td></tr></table></figure>

<p>_execute_agent_step函数里面，这里面就会让agent自动调用对应的函数执行，核心代码就是最后的ainvoke</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">_execute_agent_step</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state: State, agent, agent_name: str</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["research_team"]]:</span></span><br><span class="line">    <span class="string">"""Helper function to execute a step using the specified agent."""</span></span><br><span class="line">    current_plan = state.get(<span class="string">"current_plan"</span>)</span><br><span class="line">    plan_title = current_plan.title</span><br><span class="line">    observations = state.get(<span class="string">"observations"</span>, [])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find the first unexecuted step</span></span><br><span class="line">    current_step = <span class="literal">None</span></span><br><span class="line">    completed_steps = []</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> current_plan.steps:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> step.execution_res:</span><br><span class="line">            current_step = step</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            completed_steps.append(step)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_step:</span><br><span class="line">        logger.warning(<span class="string">"No unexecuted step found"</span>)</span><br><span class="line">        <span class="keyword">return</span> Command(goto=<span class="string">"research_team"</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f"Executing step: <span class="subst">&#123;current_step.title&#125;</span>, agent: <span class="subst">&#123;agent_name&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format completed steps information</span></span><br><span class="line">    completed_steps_info = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> completed_steps:</span><br><span class="line">        completed_steps_info = <span class="string">"# Completed Research Steps\n\n"</span></span><br><span class="line">        <span class="keyword">for</span> i, step <span class="keyword">in</span> enumerate(completed_steps):</span><br><span class="line">            completed_steps_info += <span class="string">f"## Completed Step <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>: <span class="subst">&#123;step.title&#125;</span>\n\n"</span></span><br><span class="line">            completed_steps_info += <span class="string">f"&lt;finding&gt;\n<span class="subst">&#123;step.execution_res&#125;</span>\n&lt;/finding&gt;\n\n"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prepare the input for the agent with completed steps info</span></span><br><span class="line">    agent_input = &#123;</span><br><span class="line">        <span class="string">"messages"</span>: [</span><br><span class="line">            HumanMessage(</span><br><span class="line">                content=<span class="string">f"# Research Topic\n\n<span class="subst">&#123;plan_title&#125;</span>\n\n<span class="subst">&#123;completed_steps_info&#125;</span># Current Step\n\n## Title\n\n<span class="subst">&#123;current_step.title&#125;</span>\n\n## Description\n\n<span class="subst">&#123;current_step.description&#125;</span>\n\n## Locale\n\n<span class="subst">&#123;state.get(<span class="string">'locale'</span>, <span class="string">'en-US'</span>)&#125;</span>"</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add citation reminder for researcher agent</span></span><br><span class="line">    <span class="keyword">if</span> agent_name == <span class="string">"researcher"</span>:</span><br><span class="line">        <span class="keyword">if</span> state.get(<span class="string">"resources"</span>):</span><br><span class="line">            resources_info = <span class="string">"**The user mentioned the following resource files:**\n\n"</span></span><br><span class="line">            <span class="keyword">for</span> resource <span class="keyword">in</span> state.get(<span class="string">"resources"</span>):</span><br><span class="line">                resources_info += <span class="string">f"- <span class="subst">&#123;resource.title&#125;</span> (<span class="subst">&#123;resource.description&#125;</span>)\n"</span></span><br><span class="line"></span><br><span class="line">            agent_input[<span class="string">"messages"</span>].append(</span><br><span class="line">                HumanMessage(</span><br><span class="line">                    content=resources_info</span><br><span class="line">                    + <span class="string">"\n\n"</span></span><br><span class="line">                    + <span class="string">"You MUST use the **local_search_tool** to retrieve the information from the resource files."</span>,</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        agent_input[<span class="string">"messages"</span>].append(</span><br><span class="line">            HumanMessage(</span><br><span class="line">                content=<span class="string">"IMPORTANT: DO NOT include inline citations in the text. Instead, track all sources and include a References section at the end using link reference format. Include an empty line between each citation for better readability. Use this format for each reference:\n- [Source Title](URL)\n\n- [Another Source](URL)"</span>,</span><br><span class="line">                name=<span class="string">"system"</span>,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Invoke the agent</span></span><br><span class="line">    default_recursion_limit = <span class="number">25</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        env_value_str = os.getenv(<span class="string">"AGENT_RECURSION_LIMIT"</span>, str(default_recursion_limit))</span><br><span class="line">        parsed_limit = int(env_value_str)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> parsed_limit &gt; <span class="number">0</span>:</span><br><span class="line">            recursion_limit = parsed_limit</span><br><span class="line">            logger.info(<span class="string">f"Recursion limit set to: <span class="subst">&#123;recursion_limit&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f"AGENT_RECURSION_LIMIT value '<span class="subst">&#123;env_value_str&#125;</span>' (parsed as <span class="subst">&#123;parsed_limit&#125;</span>) is not positive. "</span></span><br><span class="line">                <span class="string">f"Using default value <span class="subst">&#123;default_recursion_limit&#125;</span>."</span></span><br><span class="line">            )</span><br><span class="line">            recursion_limit = default_recursion_limit</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        raw_env_value = os.getenv(<span class="string">"AGENT_RECURSION_LIMIT"</span>)</span><br><span class="line">        logger.warning(</span><br><span class="line">            <span class="string">f"Invalid AGENT_RECURSION_LIMIT value: '<span class="subst">&#123;raw_env_value&#125;</span>'. "</span></span><br><span class="line">            <span class="string">f"Using default value <span class="subst">&#123;default_recursion_limit&#125;</span>."</span></span><br><span class="line">        )</span><br><span class="line">        recursion_limit = default_recursion_limit</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f"Agent input: <span class="subst">&#123;agent_input&#125;</span>"</span>)</span><br><span class="line">    <span class="comment"># ainvoke函数：Agent 框架会自动处理 LLM 的输出，解析是否需要调用工具，并自动执行工具调用循环</span></span><br><span class="line">    result = <span class="keyword">await</span> agent.ainvoke(</span><br><span class="line">        input=agent_input, config=&#123;<span class="string">"recursion_limit"</span>: recursion_limit&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f"research_result:<span class="subst">&#123;result&#125;</span>"</span>)</span><br><span class="line">    <span class="comment"># Process the result</span></span><br><span class="line">    response_content = result[<span class="string">"messages"</span>][<span class="number">-1</span>].content</span><br><span class="line">    logger.debug(<span class="string">f"<span class="subst">&#123;agent_name.capitalize()&#125;</span> full response: <span class="subst">&#123;response_content&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update the step with the execution result</span></span><br><span class="line">    current_step.execution_res = response_content</span><br><span class="line">    logger.info(<span class="string">f"Step '<span class="subst">&#123;current_step.title&#125;</span>' execution completed by <span class="subst">&#123;agent_name&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Command(</span><br><span class="line">        update=&#123;</span><br><span class="line">            <span class="string">"messages"</span>: [</span><br><span class="line">                HumanMessage(</span><br><span class="line">                    content=response_content,</span><br><span class="line">                    name=agent_name,</span><br><span class="line">                )</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"observations"</span>: observations + [response_content],</span><br><span class="line">        &#125;,</span><br><span class="line">        goto=<span class="string">"research_team"</span>,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>然后回到research_team，然后会判断下一个step是什么类型，如果还是research，就会再次循环，直到完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">continue_to_running_research_team</span><span class="params">(state: State)</span>:</span></span><br><span class="line">    current_plan = state.get(<span class="string">"current_plan"</span>) <span class="comment"># current_plan 是planner生成的</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> current_plan <span class="keyword">or</span> <span class="keyword">not</span> current_plan.steps:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> all(step.execution_res <span class="keyword">for</span> step <span class="keyword">in</span> current_plan.steps): <span class="comment"># 所有plan都有结果了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find first incomplete step</span></span><br><span class="line">    incomplete_step = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> current_plan.steps:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> step.execution_res:</span><br><span class="line">            incomplete_step = step</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> incomplete_step:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"planner"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行下一个step的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> incomplete_step.step_type == StepType.RESEARCH:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"researcher"</span></span><br><span class="line">    <span class="keyword">if</span> incomplete_step.step_type == StepType.PROCESSING:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"coder"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"planner"</span></span><br></pre></td></tr></table></figure>

<p>所有结果都执行完之后会回到planner</p>
<h1 id="搜索完结果之后回到planner"><a href="#搜索完结果之后回到planner" class="headerlink" title="搜索完结果之后回到planner"></a>搜索完结果之后回到planner</h1><p>由于max_plan_iterations为1，所以只迭代一次就返回了，尽管实际结果中has_enough_context还是false。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">planner_node</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    state: State, config: RunnableConfig</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> -&gt; Command[Literal["human_feedback", "reporter"]]:</span></span><br><span class="line">    <span class="string">"""Planner node that generate the full plan."""</span></span><br><span class="line">    logger.info(<span class="string">"Planner generating full plan"</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    plan_iterations = state[<span class="string">"plan_iterations"</span>] <span class="keyword">if</span> state.get(<span class="string">"plan_iterations"</span>, <span class="number">0</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    messages = apply_prompt_template(<span class="string">"planner"</span>, state, configurable)</span><br><span class="line">    logger.info(<span class="string">f"planner_node:<span class="subst">&#123;state&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.get(<span class="string">"enable_background_investigation"</span>) <span class="keyword">and</span> state.get(</span><br><span class="line">        <span class="string">"background_investigation_results"</span></span><br><span class="line">    ): </span><br><span class="line">        messages += [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"role"</span>: <span class="string">"user"</span>,</span><br><span class="line">                <span class="string">"content"</span>: (</span><br><span class="line">                    <span class="string">"background investigation results of user query:\n"</span></span><br><span class="line">                    + state[<span class="string">"background_investigation_results"</span>]</span><br><span class="line">                    + <span class="string">"\n"</span></span><br><span class="line">                ),</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> configurable.enable_deep_thinking:</span><br><span class="line">        llm = get_llm_by_type(<span class="string">"reasoning"</span>)</span><br><span class="line">    <span class="keyword">elif</span> AGENT_LLM_MAP[<span class="string">"planner"</span>] == <span class="string">"basic"</span>:</span><br><span class="line">        llm = get_llm_by_type(<span class="string">"basic"</span>).with_structured_output(</span><br><span class="line">            Plan,</span><br><span class="line">            <span class="comment"># method="json_mode",</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        llm = get_llm_by_type(AGENT_LLM_MAP[<span class="string">"planner"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the plan iterations is greater than the max plan iterations, return the reporter node</span></span><br><span class="line">    <span class="comment"># max_plan_iterations 默认是1，所以直接到reporter</span></span><br><span class="line">    <span class="keyword">if</span> plan_iterations &gt;= configurable.max_plan_iterations:</span><br><span class="line">        <span class="keyword">return</span> Command(goto=<span class="string">"reporter"</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h1 id="reporter"><a href="#reporter" class="headerlink" title="reporter"></a>reporter</h1><p>这一步就是生成结果了，代码很简单，精华都在reporter.md里面，<a href="https://github.com/bytedance/deer-flow/blob/main/src/prompts/reporter.md" target="_blank" rel="noopener">链接</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reporter_node</span><span class="params">(state: State, config: RunnableConfig)</span>:</span></span><br><span class="line">    <span class="string">"""Reporter node that write a final report."""</span></span><br><span class="line">    logger.info(<span class="string">"Reporter write final report"</span>)</span><br><span class="line">    configurable = Configuration.from_runnable_config(config)</span><br><span class="line">    current_plan = state.get(<span class="string">"current_plan"</span>)</span><br><span class="line">    input_ = &#123;</span><br><span class="line">        <span class="string">"messages"</span>: [</span><br><span class="line">            HumanMessage(</span><br><span class="line">                <span class="string">f"# Research Requirements\n\n## Task\n\n<span class="subst">&#123;current_plan.title&#125;</span>\n\n## Description\n\n<span class="subst">&#123;current_plan.thought&#125;</span>"</span></span><br><span class="line">            )</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"locale"</span>: state.get(<span class="string">"locale"</span>, <span class="string">"en-US"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    invoke_messages = apply_prompt_template(<span class="string">"reporter"</span>, input_, configurable)</span><br><span class="line">    observations = state.get(<span class="string">"observations"</span>, [])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add a reminder about the new report format, citation style, and table usage</span></span><br><span class="line">    invoke_messages.append(</span><br><span class="line">        HumanMessage(</span><br><span class="line">            content=<span class="string">"IMPORTANT: Structure your report according to the format in the prompt. Remember to include:\n\n1. Key Points - A bulleted list of the most important findings\n2. Overview - A brief introduction to the topic\n3. Detailed Analysis - Organized into logical sections\n4. Survey Note (optional) - For more comprehensive reports\n5. Key Citations - List all references at the end\n\nFor citations, DO NOT include inline citations in the text. Instead, place all citations in the 'Key Citations' section at the end using the format: `- [Source Title](URL)`. Include an empty line between each citation for better readability.\n\nPRIORITIZE USING MARKDOWN TABLES for data presentation and comparison. Use tables whenever presenting comparative data, statistics, features, or options. Structure tables with clear headers and aligned columns. Example table format:\n\n| Feature | Description | Pros | Cons |\n|---------|-------------|------|------|\n| Feature 1 | Description 1 | Pros 1 | Cons 1 |\n| Feature 2 | Description 2 | Pros 2 | Cons 2 |"</span>,</span><br><span class="line">            name=<span class="string">"system"</span>,</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拼接消息，发给llm</span></span><br><span class="line">    <span class="keyword">for</span> observation <span class="keyword">in</span> observations:</span><br><span class="line">        invoke_messages.append(</span><br><span class="line">            HumanMessage(</span><br><span class="line">                content=<span class="string">f"Below are some observations for the research task:\n\n<span class="subst">&#123;observation&#125;</span>"</span>,</span><br><span class="line">                name=<span class="string">"observation"</span>,</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    logger.debug(<span class="string">f"Current invoke messages: <span class="subst">&#123;invoke_messages&#125;</span>"</span>)</span><br><span class="line">    response = get_llm_by_type(AGENT_LLM_MAP[<span class="string">"reporter"</span>]).invoke(invoke_messages)</span><br><span class="line">    response_content = response.content</span><br><span class="line">    logger.info(<span class="string">f"reporter response: <span class="subst">&#123;response_content&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"final_report"</span>: response_content&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>coordinator接受用户输入，让llm判断需不需要分发请求，还是直接返回。如果要分发请求，下一步会到background_investigator。</p>
<p>background_investigator 会调用搜索引擎完成基本搜索。下一步会交给planer。</p>
<p>planer会对上面的基本搜索结果评估，然后生成计划。生成什么样的计划，有哪些关键点，全都写在prompt里面。</p>
<p>planner生成多个step之后，调用human_feedback，当前是不反馈，所以继续下一步。</p>
<p>research_team，负责执行上面planner的计划。当前的计划是搜索，所以research_team就会调用researcher开始搜索，搜索每一步step。</p>
<p>搜索完之后会回到planner，planner检查结果，如果ok，就会交给reporter生成结果。</p>
<p>reporter生成结果也是采用prompt控制的，交给llm生成。</p>
<p>这是langgraph生成的流程图，可以帮助理解：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/1fb6cc63a274444eb34a388bf7a713b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2F2ZTc3Nw==:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiNzEyOTQ2NzE4NjE1NzQyIn0%3D&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1756640474&x-orig-sign=jBg6pH%2FoLVsTa28iefyDd%2BLpAfo%3D" alt="屏幕截图 2025-08-24 094733.png"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://link.hhtjim.com/163/5146554.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='http://link.hhtjim.com/qq/001faIUs4M2zna.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='false'
        data-ci='c82ee42088349c609c4d'
        data-cs='541eefaa06715f3b1bcd6bf41cb69a4053d18348'
        data-r='PPeony.github.io'
        data-o='PPeony'
        data-a='PPeony'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
